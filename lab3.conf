input {                                                                                                                                                                                                             
  twitter {                                                                                                                                                                                                         
      consumer_key => "${CONS_KEY}"                                                                                                                                                                                 
      consumer_secret => "${CONS_KEY_SEC}"                                                                                                                                                                          
      oauth_token => "${OAUTH_TO}"                                                                                                                                                                                  
      oauth_token_secret => "${OAUTH_TO_SEC}"                                                                                                                                                                       
      keywords => ["HBO", "Netflix"]                                                                                                                                                                                
      type => "tweet"                                                                                                                                                                                               
      full_tweet => true                                                                                                                                                                                            
  }                                                                                                                                                                                                                 
}                                                                                                                                                                                                                   
filter {                                                                                                                                                                                                            
  prune {                                                                                                                                                                                                           
    whitelist_names => [ "^text$", "^id_str$", "^user$", "^retweeted_status$", "^entities$", "^coordinates$", "^created_at$"]                                                                                       
  }                                                                                                                                                                                                                 
  if([retweeted_status]) {                                                                                                                                                                                          
     mutate {                                                                                                                                                                                                       
        rename => {                                                                                                                                                                                                 
           "[retweeted_status][text]" => "tweet_content"                                                                                                                                                            
           "[retweeted_status][id_str]" => "original_tweet_id"                                                                                                                                                      
           "[retweeted_status][user][id_str]" => "original_author_id"                                                                                                                                               
           "[retweeted_status][user][screen_name]" => "original_author_pseudo"                                                                                                                                      
           "[retweeted_status][user][name]" => "original_author_name"                                                                                                                                               
        }                                                                                                                                                                                                           
        add_field => {                                                                                                                                                                                              
           "is_a_retweet" => true                                                                                                                                                                                   
        }                                                                                                                                                                                                           
     }                                                                                                                                                                                                              
     date {                                                                                                                                                                                                         
        match => ["[retweeted_status][created_at]", "EEE MMM dd HH:mm:ss Z yyyy"]                                                                                                                                   
        target => "original_tweet_created_at"                                                                                                                                                                       
     }                                                                                                                                                                                                              
   ruby {                                                                                                                                                                                                         
       code => '                                                                                                                                                                                                    
         event.set("tweet_coordinates", event.get("[retweeted_status][coordinates][coordinates]")) if !event.get("[retweeted_status][coordinates][coordinates]").nil?                                               
       '                                                                                                                                                                                                            
     }                                                                                                                                                                                                              
  }                                                                                                                                                                                                                 
  else{                                                                                                                                                                                                             
     mutate {                                                                                                                                                                                                       
       add_field => {                                                                                                                                                                                               
          "tweet_content" => "%{[text]}"                                                                                                                                                                            
          "is_a_retweet" => false                                                                                                                                                                                   
       }                                                                                                                                                                                                            
       rename => {                                                                                                                                                                                                  
         "[id_str]" =>  "tweet_id"                                                                                                                                                                                  
         "[user][id_str]" => "author_id"                                                                                                                                                                            
         "[user][screen_name]" => "author_pseudo"                                                                                                                                                                   
         "[user][name]" => "author_name"                                                                                                                                                                            
       }                                                                                                                                                                                                            
     }                                                                                                                                                                                                              
  }                                                                                                                                                                                                                 
  date {                                                                                                                                                                                                            
     match => ["[created_at]", "EEE MMM dd HH:mm:ss Z yyyy"]                                                                                                                                                        
     target => "tweet_created_at"                                                                                                                                                                                   
  }                                                                                                                                                                                                                 
  ruby {                                                                                                                                                                                                            
    code => '                                                                                                                                                                                                       
      hashtags = []                                                                                                                                                                                                 
      user_mentions_pseudo = []                                                                                                                                                                                     
      urls = []                                                                                                                                                                                                     
      event.get("[entities][hashtags]").each do |hashtag|                                                                                                                                                           
        hashtags << hashtag["text"].downcase                                                                                                                                                                        
      end                                                                                                                                                                                                           
      event.get("[entities][user_mentions]").each do |user_mention| 
	          user_mentions_pseudo << user_mention["screen_name"]                                                                                                                                                         
      end                                                                                                                                                                                                           
      event.get("[entities][urls]").each do |url|                                                                                                                                                                   
        urls << url["expanded_url"]                                                                                                                                                                                 
      end                                                                                                                                                                                                           
      event.set("hashtags", hashtags) if hashtags.any?                                                                                                                                                              
      event.set("user_mentions_pseudo", user_mentions_pseudo) if user_mentions_pseudo.any?                                                                                                                          
      event.set("urls", urls) if urls.any?                                                                                                                                                                          
      event.set("tweet_coordinates", event.get("[coordinates][coordinates]")) if !event.get("[coordinates][coordinates]").nil?                                                                                      
    '                                                                                                                                                                                                               
  }                                                                                                                                                                                                                 
  date {                                                                                                                                                                                                            
     match => ["[created_at]", "EEE MMM dd HH:mm:ss Z yyyy"]                                                                                                                                                        
     target => "tweet_created_at"                                                                                                                                                                                   
  }                                                                                                                                                                                                                 
                                                                                                                                                                                                                    
####################################################                                                                                                                                                                
####################################################                                                                                                                                                                
  rest {
  request => {
    url => "http://localhost:5000/predict"
    method => "POST"
    params => {
      "submit" => "%{tweet_content}"
    }
    headers => { "Content-Type" => "application/json" }
  }
  target => 'rest'
}                                                                                                                                                                                                                 
####################################################                                                                                                                                                                
####################################################                                                                                                                                                                
  mutate {                                                                                                                                                                                                          
      rename => {                 
	           "[rest][sentiment]" => "sentiment"                                                                                                                                                                         
         "[rest][score]" => "sentiment_score"                                                                                                                                                                       
      }                                                                                                                                                                                                             
      remove_field => ["retweeted_status", "entities", "user", "text", "coordinates", "created_at", "type", "rest"]                                                                                                 
  }                                                                                                                                                                                                                 
}                                                                                                                                                                                                                   
output {                                                                                                                                                                                                            
  stdout{                                                                                                                                                                                                           
        codec => dots                                                                                                                                                                                               
  }                                                                                                                                                                                                                 
  elasticsearch {                                                                                                                                                                                                   
      hosts => ["server1"]                                                                                                                                                                                          
      index => twitter                                                                                                                                                                                              
      template => "templates/twitter_template.json"                                                                                                                                                                 
      template_name => "twitter"                                                                                                                                                                                    
  }                                                                                                                                                                                                                 
}